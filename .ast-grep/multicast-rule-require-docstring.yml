# .ast-grep/multicast-rule-require-docstring.yml
utils:
  py_string_literal:
    all:
      - kind: string_content
      - any:
        - all:
            - follows:
                kind: string_start
                regex: (?:'{3})
            - precedes:
                kind: string_end
                regex: (?:'{3})
        - all:
            - follows:
                kind: string_start
                regex: (?:"{3})
            - precedes:
                kind: string_end
                regex: (?:"{3})
        - inside:
            kind: string
  docstring_pattern:
    any:
        - pattern:
            selector: string
            context: |
              """$DOC"""
        - pattern:
            selector: string
            context: |
              '''$DOC'''
    has:
        matches: py_string_literal
        kind: string_content
    inside:
      kind: expression_statement
  docstring_statement:
    pattern:
      selector: expression_statement
      context: |
        $$$
      has:
        pattern:
          selector: string
          context: |
            $docstring_pattern
    kind: expression_statement
    has:
      matches: docstring_pattern
      inside:
        kind: expression_statement
      kind: string
  module_docstring:
    all:
      - matches: docstring_statement
        inside:
          kind: module
      - kind: expression_statement
  block_docstring:
    matches: docstring_statement
    inside:
      kind: block
      has:
        matches: docstring_statement
    kind: expression_statement
    nthChild: 1
  block_with_docstring:
    all:
      - has:
          matches: block_docstring
          stopBy: neighbor
      - kind: block
        pattern: |
            $$$
  class_docstring:
    all:
      - matches: docstring_pattern
        inside:
          kind: expression_statement
          inside:
            matches: block_with_docstring
            kind: block
            inside:
              kind: class_definition
      - kind: string
  data_class_docstring:
    all:
      - matches: class_docstring
        inside:
          kind: expression_statement
          inside:
            kind: block
            has:
              kind: expression_statement
              all:
                - has:
                    kind: identifier
                - not:
                    has:
                      kind: function_definition
            inside:
              kind: class_definition
      - kind: string
  function_block:
    kind: block
    inside:
      kind: function_definition
  function_docstring:
    all:
      - matches: docstring_pattern
        inside:
          kind: expression_statement
          inside:
            kind: block
            matches: function_block
      - kind: string
  function_missing_docstring:
    precedes:
      kind: block
      has:
        kind: expression_statement
        not:
          matches: docstring_pattern
  method_docstring:
    all:
      - matches: docstring_pattern
        inside:
          kind: expression_statement
          inside:
            kind: block
            inside:
              kind: function_definition
              inside:
                kind: block
                inside:
                  kind: class_definition
      - kind: string
  cep7_docstring_purpose:
    all:
      - any:
        - matches: function_docstring
        - matches: method_docstring
        - matches: class_docstring
      - has:
          regex: \b(Verif|Check|Test)\b.*
          kind: string_content
          ends: string_end
  cep7_docstring_function_arguments:
    all:
      - any:
        - matches: function_docstring
      - has:
          regex: |
            (Args|Arguments):.*
          kind: string_content
          ends: string_end
  cep7_docstring_method_arguments:
    all:
      - any:
        - matches: method_docstring
      - has:
          regex: |
            (Params|Parameters):.*
          kind: string_content
          ends: string_end
  cep7_docstring_class_arguments:
    all:
      - any:
        - matches: data_class_docstring
      - has:
          regex: |
            (Properties|Attributes):.*
          kind: string_content
          ends: string_end
  cep7_docstring_arguments:
    any:
      - matches: cep7_docstring_class_arguments
      - matches: cep7_docstring_function_arguments
      - matches: cep7_docstring_method_arguments
  cep7_docstring_function_returns:
    all:
      - any:
        - matches: function_docstring
      - has:
          regex: |
            (Returns|Results):.*
          kind: string_content
          ends: string_end
  cep7_docstring_method_returns:
    all:
      - any:
        - matches: method_docstring
      - has:
          regex: |
            (Returns):.*
          kind: string_content
          ends: string_end
  cep7_docstring_returns:
    all:
      - any:
        - matches: cep7_docstring_function_returns
        - matches: cep7_docstring_method_returns
      - has:
          regex: |
            (Returns|Results):.*
          kind: string_content
          ends: string_end

id: check-has-docstring-documentation
rule:
  not:
    has:
      matches: block_with_docstring
      kind: block
  any:
    - kind: class_definition
      pattern:
        selector: class_definition
        context: |
          class $NAME($$$):
            $$$
            $CLASS_BODY
    - kind: function_definition
      pattern: 
        selector: function_definition
        context: |
          def $NAME($$$)$$$:
            $$$
            $FUNC_BODY
selector: identifier
language: python
message: "$NAME must have documentation, add docstring."
severity: warning
